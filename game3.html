<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dota 2 Draft Helper</title>
<style>
  body { background:#07111b; color:#fff; font-family:sans-serif; text-align:center; }
  h1 { color:#ff0000; }
  table { margin: 20px auto; border-collapse: collapse; }
  th, td { border: 1px solid #fff; padding: 5px 10px; }
</style>
</head>
<body>
<h1>Dota 2 Draft Helper — Об'єднання героїв</h1>
<div id="output"></div>

<script>
const accountId = 863386335; // твій OpenDota ID
let heroes = [];

async function loadAndMergeHeroes() {
  try {
    // 1. Локальні герої
    const localHeroes = await fetch("heroes.json").then(r => r.json());

    // 2. OpenDota API: гравець і загальні дані
    const [playerHeroes, allHeroes] = await Promise.all([
      fetch(`https://api.opendota.com/api/players/${accountId}/heroes`).then(r => r.json()),
      fetch("https://api.opendota.com/api/heroStats").then(r => r.json())
    ]);

    // 3. Мапа hero_id -> глобальні дані
    const idToData = {};
    allHeroes.forEach(h => {
      idToData[h.id] = {
        name: h.localized_name,
        globalWinrate: h.pro_pick ? h.pro_win / h.pro_pick : 0,
        globalPickrate: h.pro_pick ? h.pro_pick / 1000 : 0
      };
    });

    // 4. Злиття і обчислення підсумкового score
    heroes = localHeroes.map(local => {
      const apiHero = playerHeroes.find(a => idToData[a.hero_id]?.name === local.name);
      const globalData = allHeroes.find(h => h.localized_name === local.name);

      const globalWinrate = globalData ? (globalData.pro_win / globalData.pro_pick || 0) : 0;
      const globalPickrate = globalData ? (globalData.pro_pick / 1000 || 0) : 0;
      const localScore = local.score || 0;

      const finalScore = localScore * 0.5 + globalWinrate * 0.3 + globalPickrate * 0.2;

      return {
        ...local,
        games: apiHero ? apiHero.games : 0,
        wins: apiHero ? apiHero.win : 0,
        myWinrate: apiHero && apiHero.games > 0 ? ((apiHero.win / apiHero.games) * 100).toFixed(1) + "%" : "0%",
        globalWinrate: (globalWinrate * 100).toFixed(1) + "%",
        globalPickrate: (globalPickrate * 100).toFixed(1) + "%",
        score: Number(finalScore.toFixed(3))
      };
    });

    console.log("Герої після злиття і підрахунку score:", heroes);
    renderHeroes(heroes);

  } catch(err) {
    console.error("Помилка при завантаженні героїв:", err);
  }
}

// Функція для виводу на екран
function renderHeroes(data) {
  const container = document.getElementById("output");
  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>Герой</th>
      <th>Локальний score</th>
      <th>Global WR</th>
      <th>Global Pickrate</th>
      <th>Мій WR</th>
      <th>Ігри</th>
      <th>Фінальний score</th>
    </tr>
  `;
  data.forEach(h => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${h.name}</td>
      <td>${h.score ? h.score.toFixed(3) : 0}</td>
      <td>${h.globalWinrate}</td>
      <td>${h.globalPickrate}</td>
      <td>${h.myWinrate}</td>
      <td>${h.games}</td>
      <td>${h.score}</td>
    `;
    table.appendChild(row);
  });
  container.innerHTML = "";
  container.appendChild(table);
}

// Запуск
loadAndMergeHeroes();
</script>
</body>
</html>

