<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>game1 — Прогноз, закономірності та статистика героїв</title>
<style>
:root{--bg:#0b1220;--card:#09111a;--muted:#9aa7bd;--accent:#1f8feb}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,#071027 0%,#07111b 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
.wrap{max-width:1200px;width:100%}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:10px;margin-bottom:12px}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
h1{font-size:18px;margin:0}
.inputs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
input,button,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:9px;border-radius:8px;color:inherit}
button{cursor:pointer}
.grid{display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:14px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
.meta{font-size:13px;color:var(--muted)}
.prediction{padding:12px;border-radius:10px;margin-bottom:10px}
.pred-good{background:linear-gradient(90deg,#063b12,#0d6430);color:#dfffe0}
.pred-bad{background:linear-gradient(90deg,#3b0606,#641010);color:#ffe0e0}
.pred-neutral{background:linear-gradient(90deg,#2a2a3b,#3b3b5a);color:#fff}
.reason{font-size:13px;margin:6px 0;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
.small{font-size:12px;color:var(--muted)}
#patterns{display:none;margin-top:12px}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.hero-list{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.hero-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
.hero-item img{width:48px;height:28px;object-fit:cover;border-radius:4px}
.hero-stats{display:flex;gap:20px;flex-direction:column;margin-top:12px}
.hero-stats table{margin-bottom:10px}
@media (max-width:920px){.grid{grid-template-columns:1fr} .charts{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="card" style="flex:1;display:flex;align-items:center;justify-content:space-between;padding:12px">
<div>
<h1>game1 — Прогноз, закономірності та статистика героїв</h1>
<div class="small">OpenDota аналіз останніх ігор → прогноз, закономірності, топ-3 героїв, статистика героїв.</div>
</div>
<div class="small">Тестовий ID: <strong>863386335</strong></div>
</div>
</header>

<div class="card">
<div style="display:flex;flex-direction:column">
<label>Steam64 ID або OpenDota account_id:</label>
<div class="inputs">
<input id="idInput" placeholder="Steam64 або account_id" />
<select id="limitSelect">
<option value="20">Останні 20 ігор</option>
<option value="50">Останні 50 ігор</option>
<option value="100">Останні 100 ігор</option>
</select>
<button id="fetchBtn">Отримати прогноз</button>
<button id="patternsBtn">Показати закономірності</button>
<button id="demoBtn">Тестовий ID</button>
</div>
<div class="small" style="margin-top:8px">Натисни «Показати закономірності» після отримання прогнозу — побудуються графіки winrate по днях і годинах, топ-3 героїв та статистика всіх героїв останніх 100 матчів.</div>
</div>
</div>

<div class="grid">
<div class="card" id="leftCard">
<h3>Останні матчі</h3>
<div id="statsSummary" class="meta"></div>
<div style="margin-top:8px;max-height:420px;overflow:auto">
<table id="matchesTable">
<thead><tr><th>Дата</th><th>Герой</th><th>K/D/A</th><th>Результат</th><th>Тривалість</th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>

<aside class="card" id="rightCard">
<h3>Прогноз на наступний матч</h3>
<div id="predictionArea" class="prediction pred-neutral">Очікування...</div>
<div id="predictionDetails" class="meta"></div>

<div id="patterns" class="meta card">
<h4>Закономірності матчів</h4>
<div class="charts">
<canvas id="chartDays" width="400" height="200"></canvas>
<canvas id="chartHours" width="400" height="200"></canvas>
</div>
<div id="patternText" style="margin-top:10px"></div>

<h4 style="margin-top:10px">Топ-3 герої</h4>
<div id="topHeroes" class="hero-list"></div>

<h4 style="margin-top:10px">Статистика героїв останніх 100 матчів</h4>
<div class="hero-stats">
<table id="heroStatsMy" border="0">
<thead><tr><th>Герой</th><th>Обрано разів</th><th>Winrate (%)</th><th>Avg K/D/A</th><th>Балова оцінка</th></tr></thead>
<tbody></tbody>
</table>

<table id="heroStatsEnemy" border="0">
<thead><tr><th>Герой</th><th>Обрано разів</th><th>Winrate (%)</th><th>Avg K/D/A</th><th>Балова оцінка</th></tr></thead>
<tbody></tbody>
</table>
</div>

</div>
</aside>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function steam64ToAccountId(steam64){ try{ const n=BigInt(steam64); const base=BigInt('76561197960265728'); if(n<=BigInt(4294967295)) return Number(n); return Number(n-base);}catch(e){return NaN} }
function playerWon(m){ const playerRadiant = (m.player_slot||0) < 128; return (playerRadiant && m.radiant_win) || (!playerRadiant && !m.radiant_win); }
function secsToMinSecs(s){ const m=Math.floor(s/60), sec=s%60; return m+':'+String(sec).padStart(2,'0'); }

async function fetchOpenDotaMatches(id,limit){ const url=`https://api.opendota.com/api/players/${id}/matches?limit=${limit}`; const res=await fetch(url); if(!res.ok) throw new Error('OpenDota matches fetch failed: '+res.status); return res.json(); }
async function fetchHeroesConstants(){ const url='https://api.opendota.com/api/constants/heroes'; const res=await fetch(url); if(!res.ok) throw new Error('OpenDota heroes fetch failed'); return res.json(); }

function analyzeMatches(matches){
  const out={games:matches.length,wins:0,k:0,d:0,a:0,dur:0,shortWins:0,shortLosses:0,longWins:0,longLosses:0,leaves:0,byHero:{},seq:[],myTeam:[],enemyTeam:[]};
  for(const m of matches){ 
    const won=playerWon(m); 
    out.seq.push(won?'W':'L'); 
    if(won) out.wins++; 
    const kills=m.kills||0,deaths=m.deaths||0,assists=m.assists||0,duration=m.duration||0; 
    out.k+=kills; out.d+=deaths; out.a+=assists; out.dur+=duration; 
    if(duration<1500 && won) out.shortWins++; 
    if(duration<1500 && !won) out.shortLosses++; 
    if(duration>2700 && won) out.longWins++; 
    if(duration>2700 && !won) out.longLosses++; 
    if(m.leaver_status && m.leaver_status!==0) out.leaves++; 
    const hid=m.hero_id||0; 
    if(!out.byHero[hid]) out.byHero[hid]={games:0,wins:0,k:0,d:0,a:0}; 
    out.byHero[hid].games++; if(won) out.byHero[hid].wins++; out.byHero[hid].k+=kills; out.byHero[hid].d+=deaths; out.byHero[hid].a+=assists;
    if((m.player_slot||0)<128) out.myTeam.push(m); else out.enemyTeam.push(m);
  }
  out.winrate=out.games? out.wins/out.games*100:0; 
  out.avgK=out.games? out.k/out.games:0; out.avgD=out.games? out.d/out.games:0; out.avgA=out.games? out.a/out.games:0; 
  out.avgKDA=out.avgD? (out.avgK+out.avgA)/out.avgD: (out.avgK+out.avgA); 
  out.avgDuration=out.games? out.dur/out.games:0; 
  return out;
}

// Тут можна додати функції для прогнозів, закономірностей, топ-3 героїв і статистики героїв за 100 матчів
function fillHeroStatsTable(matches, heroesConstants, myTeamTableId, enemyTeamTableId) {
    const heroStatsMy = {};
    const heroStatsEnemy = {};

    matches.forEach(m => {
        const hid = m.hero_id;
        const won = playerWon(m);
        const team = (m.player_slot < 128) ? 'my' : 'enemy';
        const target = (team==='my') ? heroStatsMy : heroStatsEnemy;

        if(!target[hid]) target[hid] = {games:0, wins:0, k:0, d:0, a:0};
        target[hid].games++;
        if(won) target[hid].wins++;
        target[hid].k += m.kills;
        target[hid].d += m.deaths;
        target[hid].a += m.assists;
    });

    function buildTable(stats, tableId){
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = '';
        const arr = Object.entries(stats).map(([hid, data])=>{
            const name = heroesConstants[hid]?.localized_name || hid;
            const img = heroesConstants[hid]?.img ? 'https://cdn.cloudflare.steamstatic.com'+heroesConstants[hid].img : '';
            const winrate = ((data.wins/data.games)*100).toFixed(1);
            const avgK = (data.k/data.games).toFixed(1);
            const avgD = (data.d/data.games).toFixed(1);
            const avgA = (data.a/data.games).toFixed(1);
            const kda = avgD>0 ? ((avgK+avgA)/avgD).toFixed(2) : (avgK+avgA).toFixed(2);
            const score = ((avgK+avgA)/1 + parseFloat(winrate)).toFixed(1); // приклад оцінки
            return {name,img,games:data.games,winrate,avgKDA:`${avgK}/${avgD}/${avgA}`,score};
        });
        arr.sort((a,b)=>b.games-a.games); // сортуємо за кількістю виборів

        arr.forEach(hero=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><img src="${hero.img}" style="width:32px;height:18px"/> ${hero.name}</td>
                            <td>${hero.games}</td>
                            <td>${hero.winrate}</td>
                            <td>${hero.avgKDA}</td>
                            <td>${hero.score}</td>`;
            tbody.appendChild(tr);
        });
    }

    buildTable(heroStatsMy, myTeamTableId);
    buildTable(heroStatsEnemy, enemyTeamTableId);
}

// Виклик після отримання останніх матчів та підвантаження героїв
async function updateHeroStats(accountId){
    const matches = await fetchOpenDotaMatches(accountId, 100);
    const heroesConstants = await fetchHeroesConstants();
    fillHeroStatsTable(matches, heroesConstants, 'heroStatsMy', 'heroStatsEnemy');
}

// Прив'язка кнопки
document.getElementById('demoBtn').addEventListener('click', ()=>updateHeroStats(863386335));
</script>
</body>
</html>


