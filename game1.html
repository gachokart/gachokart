<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dota 2 — Аналітика і закономірності</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heatmap.js@2.0.5/build/heatmap.min.js"></script>
  <style>
    body {
      background: #0b1220;
      color: #e0e0e0;
      font-family: "Fira Sans", sans-serif;
      text-align: center;
      padding: 20px;
    }
    canvas {
      margin: 20px auto;
      background: #09111a;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    #heroHeatmap {
      width: 600px;
      height: 400px;
      margin: 30px auto;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 80%;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #333;
    }
    th { color: #5df2f2; }
    .highlight { color: #9cff57; }
  </style>
</head>
<body>

  <h1>Аналітика Dota 2 профілю</h1>
  <p>Візуалізація продуктивності, Glicko рейтинг, тренди та герої</p>

  <canvas id="radarCanvas" width="400" height="400"></canvas>
  <canvas id="trendCanvas" width="600" height="200"></canvas>
  <div id="heroHeatmap"></div>

  <table id="heroTable">
    <thead>
      <tr><th>Герой</th><th>Ігор</th><th>Вінрейт</th><th>Ефективність</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
async function renderAnalytics(accountId) {
  // === 1️⃣ Дані з OpenDota ===
  const [matchesRes, heroesRes, playerRes] = await Promise.all([
    fetch(`https://api.opendota.com/api/players/${accountId}/matches?limit=100`),
    fetch(`https://api.opendota.com/api/players/${accountId}/heroes`),
    fetch(`https://api.opendota.com/api/players/${accountId}`)
  ]);

  const matches = await matchesRes.json();
  const heroes = await heroesRes.json();
  const player = await playerRes.json();
  const mmr = (player?.mmr_estimate?.estimate) ?? 3000;


  // === 2️⃣ Метрики ===
  const wins = matches.filter(m => m.radiant_win === (m.player_slot < 128)).length;
  const winrate = wins / matches.length;

  const kda = matches.reduce((s,m)=>s+(m.kills+m.assists)/Math.max(1,m.deaths),0)/matches.length;
  const gpm = matches.reduce((s,m)=>s+m.gold_per_min,0)/matches.length/600;
  const xpm = matches.reduce((s,m)=>s+m.xp_per_min,0)/matches.length/600;
  const killPart = matches.reduce((s,m)=>s+(m.kills+m.assists)/Math.max(1,m.team_kills||40),0)/matches.length;
  const dmgPerGold = matches.reduce((s,m)=>s+(m.hero_damage/Math.max(1,m.net_worth)),0)/matches.length;
  const meanKda = kda;
  const stddev = Math.sqrt(matches.reduce((s,m)=>{
    const val=(m.kills+m.assists)/Math.max(1,m.deaths);
    return s+Math.pow(val-meanKda,2);
  },0)/matches.length);
  const consistency = 1/(1+stddev);

  // === 3️⃣ Glicko система (спрощено) ===
  // Початкове значення
  let rating = mmr, rd = 50, vol = 0.06;
  const q = Math.log(10)/400;
  function g(RD){ return 1/Math.sqrt(1+3*q*q*RD*RD/Math.PI/Math.PI); }
  function E(r,ri,RDi){ return 1/(1+Math.pow(10,-g(RDi)*(r-ri)/400)); }

  matches.forEach(m=>{
    const outcome = (m.radiant_win === (m.player_slot < 128)) ? 1 : 0;
    const oppMMR = mmr + (Math.random()*200-100);
    const E_i = E(rating, oppMMR, rd);
    const g_i = g(rd);
    const d2 = 1/(q*q*g_i*g_i*E_i*(1-E_i));
    rating += (q/(1/(rd*rd)+1/d2))*g_i*(outcome-E_i);
    rd = Math.sqrt(1/((1/(rd*rd)+1/d2)));
  });
  const glicko = Math.round(rating);

  // === 4️⃣ Формули шансів ===
  const heroImpact = 0.4*kda + 0.2*gpm + 0.2*xpm + 0.1*consistency + 0.1*killPart;
  const metaFactor = 1; // заглушка, можна брати з public API
  const fatigue = Math.max(0.8, 1 - matches.slice(-5).length*0.02);
  const partyFactor = 1; // поки немає даних про пати
  const winProb = 1/(1+Math.exp(-(heroImpact*metaFactor*fatigue*partyFactor - 1)));
  const confInterval = 0.05;

  // === 5️⃣ Візуалізація Radar ===
  const ctxR = document.getElementById("radarCanvas").getContext("2d");
  window.radarChart?.destroy?.();
  window.radarChart = new Chart(ctxR, {
    type: "radar",
    data: {
      labels: ["KDA","GPM","XPM","Consistency","KillPart","Dmg/Gold"],
      datasets: [{
        label: "Performance",
        data: [kda,gpm,xpm,consistency,killPart,dmgPerGold],
        backgroundColor: "rgba(93,242,242,0.2)",
        borderColor: "#5df2f2"
      }]
    },
    options: {
      scales:{r:{min:0,max:2,ticks:{color:"#aaa"},pointLabels:{color:"#fff"},grid:{color:"rgba(255,255,255,0.1)"}}},
      plugins:{legend:{labels:{color:"#fff"}}}
    }
  });

  // === 6️⃣ Winrate тренд ===
  const ctxT = document.getElementById("trendCanvas").getContext("2d");
  const trendData = matches.slice(-20).map((m,i)=>({
    x:i+1,
    y:(m.radiant_win === (m.player_slot<128))?1:0
  }));
  window.trendChart?.destroy?.();
  window.trendChart = new Chart(ctxT,{
    type:"line",
    data:{datasets:[{label:"Win/Loss Trend",data:trendData,borderColor:"#9cff57",backgroundColor:"rgba(156,255,87,0.2)",tension:0.2}]},
    options:{scales:{x:{ticks:{color:"#ccc"}},y:{min:0,max:1,ticks:{color:"#ccc",stepSize:1}}},plugins:{legend:{labels:{color:"#fff"}}}}
  });

  // === 7️⃣ Heatmap по героях ===
  const heroHeatmap = h337.create({
    container: document.getElementById('heroHeatmap'),
    radius: 40,
    maxOpacity: 0.6,
    backgroundColor: "rgba(0,0,0,0.3)"
  });
  const heroData = heroes.map((h,i)=>({
    x:(i%10)*60+30,
    y:Math.floor(i/10)*40+30,
    value:h.win/Math.max(1,h.games)
  }));
  heroHeatmap.setData({max:1,data:heroData});

  // === 8️⃣ Таблиця героїв ===
  const tbody = document.querySelector("#heroTable tbody");
  tbody.innerHTML="";
  heroes.sort((a,b)=>(b.win/b.games)-(a.win/a.games));
  heroes.slice(0,10).forEach(h=>{
    const tr=document.createElement("tr");
    const eff=(h.win/Math.max(1,h.games)).toFixed(2);
    tr.innerHTML=`<td>${h.hero_id}</td><td>${h.games}</td><td>${(eff*100).toFixed(1)}%</td><td>${(eff*kda).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

  // === 9️⃣ Підсумок ===
  console.log({
    winrate:(winrate*100).toFixed(1)+"%",
    glicko,
    heroImpact:heroImpact.toFixed(2),
    predictedWin:(winProb*100).toFixed(1)+"% ±"+(confInterval*100).toFixed(1)+"%"
  });
}

// Запуск
renderAnalytics(863386335); // твій accountId
</script>

</body>
</html>
















