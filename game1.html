<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>game1 — Dota прогноз матчу</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#1f8feb;--muted:#9aa7bd;color-scheme:dark}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(180deg,#071027 0%,#07111b 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{max-width:980px;width:100%}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);padding:16px;border-radius:12px}
    .inputs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input,button,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:inherit}
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:14px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    .meta{font-size:13px;color:var(--muted)}
    .prediction{padding:12px;border-radius:10px;margin-bottom:10px}
    .pred-good{background:linear-gradient(90deg,#063b12,#0d6430);color:#dfffe0}
    .pred-bad{background:linear-gradient(90deg,#3b0606,#641010);color:#ffe0e0}
    .pred-neutral{background:linear-gradient(90deg,#2a2a3b,#3b3b5a);color:#fff}
    .explain{font-size:13px;color:var(--muted);margin-top:8px}
    footer{margin-top:14px;font-size:13px;color:var(--muted)}
    @media (max-width:820px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="card" style="display:flex;align-items:center;gap:12px">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 12C2 6.477 6.477 2 12 2s10 4.477 10 10-4.477 10-10 10S2 17.523 2 12z" stroke="#61dafb" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div>
          <h1>game1 — Статистика Dota → прогноз на наступний матч</h1>
          <div class="meta">Введіть SteamID64 або OpenDota account_id. Сценарій використовує OpenDota для історії ігор.</div>
        </div>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;flex-direction:column">
        <label>Steam64 ID (наприклад: 76561197960265728) або OpenDota account_id (32-bit)</label>
        <div class="inputs">
          <input id="idInput" placeholder="Steam64 або account_id" />
          <select id="limitSelect">
            <option value="20">Останні 20 ігор</option>
            <option value="50">Останні 50 ігор</option>
            <option value="100">Останні 100 ігор</option>
          </select>
          <button id="fetchBtn">Отримати статистику & прогноз</button>
          <button id="demoBtn">Завантажити демо (тестовий account_id)</button>
        </div>
        <div class="explain">Примітка: щоб працювало — сторони API (OpenDota) мають бути доступні. Конвертація Steam64 → account_id: account_id = steam64 - 76561197960265728</div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="leftCard">
        <div id="predictionArea"></div>
        <h3 style="margin-top:6px">Останні матчі</h3>
        <div id="statsSummary" class="meta"></div>
        <div style="margin-top:8px;max-height:380px;overflow:auto">
          <table id="matchesTable">
            <thead><tr><th>Дата</th><th>Герой</th><th>K/D/A</th><th>Результат</th><th>Тривалість</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <aside class="card" id="rightCard">
        <h3>Пояснення прогнозу</h3>
        <div class="meta" id="explainDetails">—</div>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0" />
        <h4>Швидка аналітика</h4>
        <ul id="quickList" class="meta" style="padding-left:18px"></ul>
        <footer>algorithm: heuristic — аналіз останніх ігор, KDA, winrate. Це не ML-модель, дає орієнтовний прогноз.</footer>
      </aside>
    </div>
  </div>

  <script>
    // Користувацькі допоміжні функції
    function steam64ToAccountId(steam64) {
      // Якщо введено вже 32-bit (менше 2^32), повертаємо як є
      const n = BigInt(steam64);
      const base = BigInt('76561197960265728');
      if (n <= BigInt(4294967295)) return Number(n);
      return Number(n - base);
    }

    function playerWon(match){
      // match.player_slot: 0-127 radiant, 128-255 dire
      const playerRadiant = match.player_slot < 128;
      const radiantWin = match.radiant_win;
      return (playerRadiant && radiantWin) || (!playerRadiant && !radiantWin);
    }

    function secsToMinSecs(s){
      const m = Math.floor(s/60), sec = s%60; return m+':'+String(sec).padStart(2,'0');
    }

    async function fetchOpenDota(account_id, limit=20){
      const url = `https://api.opendota.com/api/players/${account_id}/matches?limit=${limit}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('OpenDota fetch failed: '+res.status);
      return res.json();
    }

    function analyzeMatches(matches){
      const summary = {games:matches.length,wins:0,kills:0,deaths:0,assists:0,duration:0};
      for(const m of matches){
        const won = playerWon(m);
        if(won) summary.wins++;
        summary.kills += (m.kills||0);
        summary.deaths += (m.deaths||0);
        summary.assists += (m.assists||0);
        summary.duration += (m.duration||0);
      }
      summary.winrate = summary.games? (summary.wins/summary.games*100):0;
      summary.avgK = summary.games? (summary.kills/summary.games):0;
      summary.avgD = summary.games? (summary.deaths/summary.games):0;
      summary.avgA = summary.games? (summary.assists/summary.games):0;
      summary.avgKDA = summary.avgD? ((summary.avgK+summary.avgA)/summary.avgD): (summary.avgK+summary.avgA);
      summary.avgDuration = summary.games? Math.round(summary.duration/summary.games):0;
      return summary;
    }

    function makeHeuristicPrediction(summary){
      // Проста евристика, комбінація winrate і KDA
      const w = summary.winrate; const kda = summary.avgKDA;
      let score = 0;
      // weight winrate strongly
      score += (w-50) * 0.8; // якщо winrate >50 дає плюс
      // kda influence
      score += (kda-2) * 5; // KDA 3 дає +5
      // якщо середня тривалість коротка (<20) додаємо невеликий штраф — може бути рофл
      if(summary.avgDuration < 1200) score -= 2;

      // нормалізуємо в ймовірність 0-100
      let prob = 50 + score;
      prob = Math.max(3, Math.min(97, Math.round(prob)));

      let label = 'Нейтральний прогноз';
      let css = 'pred-neutral';
      if (prob >= 65){ label = 'Висока ймовірність перемоги'; css='pred-good'; }
      else if (prob <= 40){ label = 'Низька ймовірність перемоги'; css='pred-bad'; }
      return {prob,label,css,score};
    }

    function renderMatches(matches){
      const tbody = document.querySelector('#matchesTable tbody'); tbody.innerHTML='';
      for(const m of matches){
        const tr = document.createElement('tr');
        const d = new Date((m.start_time||0)*1000);
        const hero = (m.hero_id||m.hero_id===0)? (m.hero_id): '—';
        const kdastr = `${m.kills||0}/${m.deaths||0}/${m.assists||0}`;
        const won = playerWon(m) ? 'Перемога' : 'Поразка';
        const dur = secsToMinSecs(m.duration||0);
        tr.innerHTML = `<td>${d.toLocaleString()}</td><td>${hero}</td><td>${kdastr}</td><td>${won}</td><td>${dur}</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderSummary(summary){
      const s = document.getElementById('statsSummary');
      s.innerText = `Ігор: ${summary.games} · Виграно: ${summary.wins} (${summary.winrate.toFixed(1)}%) · avg K/D/A: ${summary.avgK.toFixed(2)}/${summary.avgD.toFixed(2)}/${summary.avgA.toFixed(2)} · avg KDA: ${summary.avgKDA.toFixed(2)} · avg тривалість: ${Math.round(summary.avgDuration/60)} хв`;
    }

    function renderPrediction(pred, summary){
      const area = document.getElementById('predictionArea');
      area.innerHTML = '';
      const box = document.createElement('div'); box.className = `prediction ${pred.css}`;
      box.innerHTML = `<strong style="font-size:18px">${pred.label}</strong><div style="margin-top:6px">Ймовірність (евристично): <strong>${pred.prob}%</strong></div>`;
      area.appendChild(box);

      // explain
      const explain = document.getElementById('explainDetails');
      explain.innerHTML = `Оцінка на основі: winrate (${summary.winrate.toFixed(1)}%) і середнього KDA (${summary.avgKDA.toFixed(2)}). Евристичне значення: ${pred.score.toFixed(2)}.`;

      const q = document.getElementById('quickList'); q.innerHTML='';
      const items = [
        `Winrate → ${summary.winrate.toFixed(1)}%`,
        `Avg K/D/A → ${summary.avgK.toFixed(2)}/${summary.avgD.toFixed(2)}/${summary.avgA.toFixed(2)}`,
        `Avg KDA → ${summary.avgKDA.toFixed(2)}`,
        `Середня тривалість → ${Math.round(summary.avgDuration/60)} хв`
      ];
      items.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; q.appendChild(li); });
    }

    document.getElementById('demoBtn').addEventListener('click',()=>{
      // демо account_id — приклад: опендота account_id для публічних акаунтів, беремо 863386335 якщо хочете
      document.getElementById('idInput').value = '863386335';
    });

    document.getElementById('fetchBtn').addEventListener('click', async ()=>{
      const raw = document.getElementById('idInput').value.trim();
      if(!raw){ alert('Введіть Steam64 ID або OpenDota account_id'); return; }
      let account_id = null;
      try{
        if(raw.length > 12){ // ймовірно Steam64
          account_id = steam64ToAccountId(raw);
        } else {
          account_id = Number(raw);
        }
        if(isNaN(account_id)) throw new Error('Invalid id');
      } catch(e){ alert('Не вдалося розпізнати ID — вкажіть Steam64 або account_id'); return; }

      const limit = Number(document.getElementById('limitSelect').value);
      const predictionArea = document.getElementById('predictionArea'); predictionArea.innerHTML = '<div class="meta">Завантаження...</div>';

      try{
        const matches = await fetchOpenDota(account_id, limit);
        if(!Array.isArray(matches) || matches.length===0){ predictionArea.innerHTML = '<div class="meta">Немає доступних останніх матчів або профіль приватний.</div>'; return; }
        renderMatches(matches);
        const summary = analyzeMatches(matches);
        renderSummary(summary);
        const pred = makeHeuristicPrediction(summary);
        renderPrediction(pred, summary);
      }catch(err){ predictionArea.innerHTML = `<div class="meta">Помилка: ${err.message}</div>`; console.error(err); }
    });

    // Автозапуск тесту при відкритті — закоментуйте якщо не треба
    // document.getElementById('demoBtn').click();

  </script>
</body>
</html>
