<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Dota 2 Role Prediction – OpenDota</title>
  <style>
    body { background:#0f1320; color:#e8ebff; font-family:sans-serif; margin:0; }
    header { background:#171b2e; padding:12px; position:sticky; top:0; }
    h1 { margin:0 0 8px; }
    input,button { padding:8px; border-radius:6px; border:1px solid #333; }
    button { background:#6aa9ff; color:#000; font-weight:bold; cursor:pointer; }
    .panel { background:#171b2e; margin:12px; padding:12px; border-radius:8px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:6px; margin:2px; font-size:12px; }
    .win { background:#35c46e33; color:#35c46e; }
    .loss { background:#ff6b6b33; color:#ff6b6b; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { border-bottom:1px solid #333; padding:6px; font-size:13px; }
  </style>
</head>
<body>
  <header>
    <h1>Прогноз наступного матчу</h1>
    <input id="accountId" value="863386335" placeholder="Steam32 ID">
    <button onclick="run()">Запустити аналіз</button>
  </header>

  <div id="forecast" class="panel"></div>
  <div id="streaks" class="panel"></div>

<script>
const API = "https://api.opendota.com/api";
const ROLE_LABELS = ["Hard Support","Support","Offlane","Mid","Carry"];

async function fetchRecentMatches(accountId, limit=20) {
  const res = await fetch(`${API}/players/${accountId}/matches?limit=${limit}`);
  return res.json();
}
async function fetchFullMatch(matchId) {
  const res = await fetch(`${API}/matches/${matchId}`);
  return res.json();
}

// Визначення ролей відносно команди
function inferRolesByTeam(match, accountId) {
  const me = match.players.find(p => p.account_id == accountId);
  if (!me) return "Unknown";
  const isRadiant = me.player_slot < 128;
  const teamPlayers = match.players.filter(p => (p.player_slot < 128) === isRadiant);

  const roles = {};
  const byGPM = [...teamPlayers].sort((a,b)=>b.gold_per_min - a.gold_per_min);
  roles[byGPM[0].account_id] = "Carry";

  const byXPM = [...teamPlayers].sort((a,b)=>b.xp_per_min - a.xp_per_min);
  const mid = byXPM.find(p => !roles[p.account_id]);
  if (mid) roles[mid.account_id] = "Mid";

  const offlane = byGPM.find(p => !roles[p.account_id]);
  if (offlane) roles[offlane.account_id] = "Offlane";

  const supports = teamPlayers.filter(p => !roles[p.account_id]);
  if (supports.length === 2) {
    const hard = supports[0].assists >= supports[1].assists ? supports[0] : supports[1];
    const soft = hard === supports[0] ? supports[1] : supports[0];
    roles[hard.account_id] = "Hard Support";
    roles[soft.account_id] = "Support";
  }
  return roles[accountId] || "Unknown";
}

async function run() {
  const accountId = document.getElementById("accountId").value.trim();
  document.getElementById("forecast").innerText = "Завантаження...";
  const recent = await fetchRecentMatches(accountId, 20);

  const stats = { "Carry":{w:0,t:0}, "Mid":{w:0,t:0}, "Offlane":{w:0,t:0}, "Support":{w:0,t:0}, "Hard Support":{w:0,t:0} };
  const results = [];

  for (const m of recent) {
    const full = await fetchFullMatch(m.match_id);
    const role = inferRolesByTeam(full, accountId);
    const win = (m.radiant_win && m.player_slot<128) || (!m.radiant_win && m.player_slot>=128);
    results.push(win?1:0);
    if (stats[role]) {
      stats[role].t++;
      if (win) stats[role].w++;
    }
  }

  // Прогноз шансів перемоги
  let forecastHTML = "<h2>Ймовірність перемоги по ролях</h2>";
  for (const r of Object.keys(stats)) {
    if (stats[r].t>0) {
      const wr = stats[r].w / stats[r].t;
      forecastHTML += `<div class="pill ${wr>=0.5?'win':'loss'}">${r}: ${(wr*100).toFixed(1)}% (на ${stats[r].t} матчах)</div>`;
    }
  }
  document.getElementById("forecast").innerHTML = forecastHTML;

  // Аналіз серій
  let cur=0, bestWin=0, bestLose=0;
  for (const w of results) {
    if (w===1) { cur = cur>=0?cur+1:1; bestWin=Math.max(bestWin,cur); }
    else { cur = cur<=0?cur-1:-1; bestLose=Math.max(bestLose,-cur); }
  }
  let streakHTML = "<h2>Серії</h2>";
  if (cur>0) streakHTML += `<div class="pill win">Поточна win-streak: ${cur}</div>`;
  else if (cur<0) streakHTML += `<div class="pill loss">Поточна lose-streak: ${-cur}</div>`;
  else streakHTML += `<div class="pill">Немає серії</div>`;

  // Ймовірність початку нової серії
  if (cur===0) {
    // якщо зараз серії немає, оцінюємо шанс початку
    const last10 = results.slice(-10);
    const wr10 = last10.reduce((s,x)=>s+x,0)/last10.length;
    streakHTML += `<div class="pill warn">Шанс почати win-streak: ${(wr10*100).toFixed(1)}%</div>`;
    streakHTML += `<div class="pill warn">Шанс почати lose-streak: ${((1-wr10)*100).toFixed(1)}%</div>`;
  }
  document.getElementById("streaks").innerHTML = streakHTML;
}
</script>
</body>
</html>







