<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Dota 2 Role Analyzer</title>
  <style>
    body { background:#111; color:#eee; font-family:monospace; padding:20px; }
    h1 { color:#6cf; }
    .match { margin:5px 0; padding:5px; border-bottom:1px solid #333; }
    .good { color:#6f6; }
    .bad { color:#f66; }
    table { border-collapse: collapse; margin-top:20px; }
    td, th { border:1px solid #444; padding:5px 10px; }
  </style>
</head>
<body>
  <h1>Dota 2 Match & Role Analyzer</h1>
  <div id="summary"></div>
  <div id="role-summary"></div>
  <div id="matches"></div>

  <script>
    const steamApiKey = "F376439B1833C7DF76D6AB25A571755E";   // üîë –≤—Å—Ç–∞–≤ —Å–≤—ñ–π –∫–ª—é—á
    const accountId32 = 863386304;        // –∑–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π Steam32 ID
    const MATCH_COUNT = 100;               // –º–æ–∂–Ω–∞ –∑–±—ñ–ª—å—à–∏—Ç–∏ –¥–æ 100

    // –ú–∞–ø–∞ –≥–µ—Ä–æ—ó–≤ –¥–æ —Ä–æ–ª–µ–π (—Å–ø—Ä–æ—â–µ–Ω–æ, –º–æ–∂–Ω–∞ —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏)
    const roleMap = {
      1: "Carry", 2: "Carry", 3: "Mid", 4: "Offlane", 5: "Support",
      6: "Support", 7: "Carry", 8: "Mid", 9: "Offlane", 10: "Support"
      // TODO: –¥–æ–¥–∞—Ç–∏ –≤—Å—ñ hero_id –∑ Dota 2
    };

    async function fetchMatchHistory() {
      const url = `https://api.steampowered.com/IDOTA2Match_570/GetMatchHistory/v1/?key=${steamApiKey}&account_id=${accountId32}&matches_requested=${MATCH_COUNT}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.result.matches;
    }

    async function fetchMatchDetails(matchId) {
      const url = `https://api.steampowered.com/IDOTA2Match_570/GetMatchDetails/v1/?key=${steamApiKey}&match_id=${matchId}`;
      const res = await fetch(url);
      const data = await res.json();
      return data.result;
    }

    function analyzePlayer(matchDetails, accountId32) {
      const player = matchDetails.players.find(p => p.account_id === accountId32);
      if (!player) return null;
      const k = player.kills;
      const d = player.deaths;
      const a = player.assists;
      const kda = ((k + a) / Math.max(1, d)).toFixed(2);
      const radiantWin = matchDetails.radiant_win;
      const isRadiant = player.player_slot < 128;
      const win = (radiantWin && isRadiant) || (!radiantWin && !isRadiant);
      const role = roleMap[player.hero_id] || "Unknown";
      return { k, d, a, kda, win, duration: matchDetails.duration, role, hero: player.hero_id };
    }

    async function analyzeMatches() {
      const matches = await fetchMatchHistory();
      const container = document.getElementById("matches");
      let wins = 0, total = 0, sumKDA = 0, sumDur = 0;
      let boosters = 0, ruiners = 0;

      // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è—Ö
      const roleStats = {};

      for (const m of matches) {
        const details = await fetchMatchDetails(m.match_id);
        const stats = analyzePlayer(details, accountId32);
        if (!stats) continue;

        total++;
        if (stats.win) wins++;
        sumKDA += parseFloat(stats.kda);
        sumDur += stats.duration;

        // –ø—Ä–æ—Å—Ç—ñ –µ–≤—Ä–∏—Å—Ç–∏–∫–∏
        if (stats.kda >= 6 && stats.win) boosters++;
        if (stats.kda <= 1 && !stats.win) ruiners++;

        // –Ω–∞–∫–æ–ø–∏—á—É—î–º–æ –ø–æ —Ä–æ–ª—è—Ö
        if (!roleStats[stats.role]) {
          roleStats[stats.role] = { games:0, wins:0, sumKDA:0 };
        }
        roleStats[stats.role].games++;
        if (stats.win) roleStats[stats.role].wins++;
        roleStats[stats.role].sumKDA += parseFloat(stats.kda);

        const div = document.createElement("div");
        div.className = "match";
        div.innerHTML = `Match ${m.match_id}: 
          <span class="${stats.win ? 'good':'bad'}">${stats.win ? 'WIN':'LOSS'}</span> 
          | Hero=${stats.hero} | Role=${stats.role} 
          | K=${stats.k}, D=${stats.d}, A=${stats.a}, KDA=${stats.kda}`;
        container.appendChild(div);
      }

      const avgKDA = (sumKDA / total).toFixed(2);
      const avgDur = (sumDur / total / 60).toFixed(1);
      const winrate = ((wins / total) * 100).toFixed(1);

      // –ø—Ä–æ—Å—Ç–∏–π –ø—Ä–æ–≥–Ω–æ–∑
      const nextWinChance = winrate;
      const boosterChance = ((boosters / total) * 100).toFixed(1);
      const ruinerChance = ((ruiners / total) * 100).toFixed(1);

      document.getElementById("summary").innerHTML = `
        <h2>üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (${total} –º–∞—Ç—á—ñ–≤)</h2>
        Winrate: ${winrate}%<br>
        –°–µ—Ä–µ–¥–Ω—ñ–π KDA: ${avgKDA}<br>
        –°–µ—Ä–µ–¥–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: ${avgDur} —Ö–≤<br><br>
        üîÆ –ü—Ä–æ–≥–Ω–æ–∑:<br>
        –®–∞–Ω—Å –ø–µ—Ä–µ–º–æ–≥–∏ —É –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –º–∞—Ç—á—ñ: ${nextWinChance}%<br>
        –®–∞–Ω—Å –∑—É—Å—Ç—Ä—ñ—Ç–∏ –±—É—Å—Ç–µ—Ä–∞: ${boosterChance}%<br>
        –®–∞–Ω—Å –∑—É—Å—Ç—Ä—ñ—Ç–∏ —Ä—É—ñ–Ω–µ—Ä–∞: ${ruinerChance}%
      `;

      // —Ç–∞–±–ª–∏—Ü—è –ø–æ —Ä–æ–ª—è—Ö
      let table = `<h2>üìå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–æ–ª—è—Ö</h2><table><tr><th>–†–æ–ª—å</th><th>–Ü–≥–æ—Ä</th><th>Winrate</th><th>–°–µ—Ä–µ–¥–Ω—ñ–π KDA</th></tr>`;
      for (const role in roleStats) {
        const r = roleStats[role];
        const wr = ((r.wins / r.games) * 100).toFixed(1);
        const rkda = (r.sumKDA / r.games).toFixed(2);
        table += `<tr><td>${role}</td><td>${r.games}</td><td>${wr}%</td><td>${rkda}</td></tr>`;
      }
      table += "</table>";
      document.getElementById("role-summary").innerHTML = table;
    }

    analyzeMatches();
  </script>
</body>
</html>
